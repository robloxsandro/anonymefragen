<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Anonyme Nachrichten an Sandro</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
<link id="favicon" rel="icon" href="" type="image/png">

<!-- Cloudflare Turnstile -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<style>
body{
  margin:0;
  font-family:Montserrat,system-ui;
  background:linear-gradient(120deg,#0b5a2f,#02140b);
  color:#fff;
}
.wrapper{
  max-width:720px;
  margin:40px auto;
  padding:20px;
}
h1{font-weight:900}
textarea{
  width:100%;
  min-height:160px;
  border-radius:12px;
  border:none;
  padding:14px;
  font-size:16px;
}
button{
  margin-top:12px;
  padding:12px 18px;
  border-radius:12px;
  border:none;
  font-weight:800;
  background:#29d07a;
  cursor:pointer;
}
button:disabled{opacity:.6}
#captcha{margin-top:16px;display:none}
.toast{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,.7);
  padding:12px 16px;
  border-radius:12px;
  font-weight:700;
}
.overlay{
  position:fixed;
  inset:0;
  background:#000;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  gap:16px;
}
</style>
</head>
<body>

<div class="wrapper">
  <h1>Anonyme Nachricht</h1>
  <textarea id="msg" placeholder="Nachricht hier eingeben..."></textarea>
  <div id="captcha"></div>
  <button id="send">Absenden</button>
</div>

<div id="toast"></div>

<script>
/* ================= KONFIG ================= */
const WORKER_URL = 'https://anonymefragen.sandrorobloxcreations.workers.dev';
const TURNSTILE_SITE_KEY = '0x4AAAAAACG_VpwEjC-i_bxF';

/* ================= STATE ================= */
let token = null;
let widgetId = null;
let sending = false;

/* ================= UI ================= */
function toast(text, t=3000){
  const el = document.createElement('div');
  el.className='toast';
  el.textContent=text;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),t);
}

/* ================= TURNSTILE ================= */
function renderCaptcha(){
  if(widgetId !== null) return;
  document.getElementById('captcha').style.display='block';
  widgetId = turnstile.render('#captcha',{
    sitekey: TURNSTILE_SITE_KEY,
    theme:'dark',
    callback:(t)=>{
      token = t;
      toast('Captcha gelÃ¶st â€“ erneut absenden');
    },
    'expired-callback':()=>{
      token = null;
      toast('Captcha abgelaufen');
    }
  });
}

function resetCaptcha(){
  try{ turnstile.reset(widgetId); }catch{}
  token = null;
  widgetId = null;
  document.getElementById('captcha').innerHTML='';
  document.getElementById('captcha').style.display='none';
}

/* ================= SEND ================= */
document.getElementById('send').onclick = async ()=>{
  if(sending) return;

  const msg = document.getElementById('msg').value.trim();
  if(!msg){
    toast('Nachricht leer');
    return;
  }

  if(!token){
    renderCaptcha();
    toast('Bitte Captcha lÃ¶sen');
    return;
  }

  sending = true;
  document.getElementById('send').disabled = true;

  try{
    const res = await fetch(WORKER_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ message: msg, token })
    });

    const data = await res.json();

    if(!res.ok){
      toast(data.error || 'Fehler');
      if(res.status === 401) resetCaptcha();
      if(res.status === 429) toast('Bitte 10 Sekunden warten',4000);
      return;
    }

    showSuccess();
    resetCaptcha();
    document.getElementById('msg').value='';
  }catch{
    toast('Netzwerkfehler');
  }finally{
    sending = false;
    document.getElementById('send').disabled = false;
  }
};

/* ================= SUCCESS ================= */
function showSuccess(){
  const o = document.createElement('div');
  o.className='overlay';
  o.innerHTML = `
    <h2>Nachricht gesendet ðŸŽ‰</h2>
    <button onclick="location.reload()">Noch eine senden</button>
  `;
  document.body.appendChild(o);
}
</script>

</body>
</html>
